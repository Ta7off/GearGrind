{% extends 'core/base.html' %}
{% load crispy_forms_filters %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/detail_post.css' %}">
{% endblock %}
{% block title %}Post Details{% endblock %}

{% block content %}
    <h3>Post associated with {{ post.car.owner.username }}'s {{ post.car.make }} {{ post.car.model }}</h3>
    {% if post.images %}
        <div class="post-with-image">
        <div class="image">
            <img src="{{ post.images.url }}" alt="post image">
        </div>
        <div class="info-profile-wrapper">
            <div class="info-wrapper">
                <div class="info-title">
                    <h1>{{ post.title }}</h1>
                </div>
                {% if post.description %}
                    <div class="info-description">
                        <h3>
                            {{ post.description }}
                        </h3>
                    </div>
                {% endif %}
                <p class="post-date">date created:{{ post.created_at|date:"F j, Y, g:i a" }}</p>
            </div>
            <div class="profile-wrapper">
                <div class="profile-image">
                    <a href="{% url 'user-details' post.author.id %}">
                        <img src="{{ post.author.profile_image.url }}" alt="user pfp">
                    </a>
                </div>
                <div class="profile-info">
                    <h3>
                        {{ post.author.username }}
                    </h3>
                    {% if post.author.is_dealership %}
                        <h5>
                            Dealership
                        </h5>
                    {% else %}
                        <h5>
                            User
                        </h5>
                    {% endif %}
                </div>
            </div>
            {% if request.user == post.author %}
                <div class="post-actions">
                    <form method="POST" action="{% url 'delete-post' post.pk %}">
                        {% csrf_token %}
                        <button type="submit" class="delete-icon-button"
                                onclick="return confirm('Are you sure you want to delete this post?')"
                                title="Delete Post">
                            <img src='{% static "assets/delete_post.png" %}' alt="Delete" class="delete-icon">
                        </button>
                    </form>
                </div>
            {% endif %}
        </div>
    {% else %}
        <div class="post-no-image">
            <div class="info-profile-wrapper">
                <div class="info-wrapper">
                    <div class="info-title">
                        <h1>{{ post.title }}</h1>
                    </div>
                    {% if post.description %}
                        <div class="info-description">
                            <h3>
                                {{ post.description }}
                            </h3>
                        </div>
                    {% endif %}
                    <div class="info-description">
                        {% if post.description %}
                            <h3>
                                {{ post.description }}
                            </h3>
                        {% endif %}
                    </div>
                    <p class="post-date" style="justify-content: flex-start">date
                        created:{{ post.created_at|date:"F j, Y, g:i a" }}</p>

                </div>
                <div class="profile-wrapper">
                    <div class="profile-image">
                        <a href="{% url 'user-details' post.author.id %}">
                            <img src="{{ post.author.profile_image.url }}" alt="user pfp">
                        </a>
                    </div>
                    <div class="profile-info">
                        <h3>
                            {{ post.author.username }}
                        </h3>
                        {% if post.author.is_dealership %}
                            <h5>
                                Dealership
                            </h5>
                        {% else %}
                            <h5>
                                User
                            </h5>
                        {% endif %}
                    </div>
                </div>
                {% if request.user == post.author %}
                    <div class="post-actions">
                        <form method="POST" action="{% url 'delete-post' post.pk %}">
                            {% csrf_token %}
                            <button type="submit" class="delete-icon-button"
                                    onclick="return confirm('Are you sure you want to delete this post?')"
                                    title="Delete Post">
                                <img src='{% static "assets/delete_post.png" %}' alt="Delete" class="delete-icon">
                            </button>
                        </form>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
<div class="interaction-bar">
    <div class="interaction-buttons">
        <form method="POST" action="{% url 'like-post' post.pk %}" class="like-form">
            {% csrf_token %}
            <button type="submit" class="like-button" title="Like this post">
                {% if request.user in post.likes.all %}
                    <img src='{% static "assets/liked_post_tp.png" %}' alt="Liked">
                {% else %}
                    <img src='{% static "assets/like_post.png" %}' alt="Like">
                {% endif %}
                {{ post.total_likes }}
            </button>
        </form>

        <form method="POST" action="{% url 'dislike-post' post.pk %}" class="dislike-form">
            {% csrf_token %}
            <button type="submit" class="dislike-button" title="Dislike this post">
                {% if request.user in post.dislikes.all %}
                    <img src='{% static "assets/disliked_icon_tp.png" %}' alt="Disliked">
                {% else %}
                    <img src='{% static "assets/dislike_post.png" %}' alt="Dislike">
                {% endif %}
                {{ post.total_dislikes }}
            </button>
        </form>
    </div>

    {% if post.car.is_listed %}
        <div class="place-bid-wrapper">
            <div style="display: flex; justify-content: center; align-items: center; gap: 12px
;    pointer-events: none; user-select: none; cursor: default;">
                <h1 style="color: #EB603E; align-items: center">
                    {{ post.car.owner.username }}'s {{ post.car.make }} {{ post.car.model }} is up for bidding
                </h1>
                <img style="width: 39.2px; height: 39.2px" src='{% static "assets/Red_circle.gif" %}' alt="">
            </div>
            {% if post.car.owner != request.user %}
                <a style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px"
                   href="{% url 'place-bid' post.car.id %}">
                    <img style="width: 90px; height: 90px" src='{% static "assets/place_bid.png" %}' alt="">
                </a>
            {% endif %}
        </div>

    {% endif %}

    <a href="{% url 'car-detail' post.car.id %}" class="car-details-icon">
        <img src='{% static "assets/car_detail.png" %}' alt="car-details">
    </a>
</div>
<div class="comments-section">
    <h3>Comments</h3>

    <form method="POST" class="comment-form">
        {% csrf_token %}
        {{ form|crispy }}
        <button type="submit" class="buttons">Post Comment</button>
    </form>

    <div class="comment-list">
        {% for comment in comments %}
            <div class="comment-card">
                <div class="comment-header">
                    <strong>{{ comment.author.username }}</strong>
                    <span class="comment-date">{{ comment.created_at|date:"M d, Y H:i" }}</span>
                </div>
                <p class="comment-text">{{ comment.comment }}</p>
            </div>
        {% empty %}
            <p class="no-comments">No comments yet. Be the first to share your thoughts!</p>
        {% endfor %}
    </div>
</div>
{% endblock %}